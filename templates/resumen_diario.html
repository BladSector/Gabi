{% extends "base.html" %}

{% block title %}Resumen Diario - Sistema de Restaurante{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-2">INFORME DE VENTAS DIARIAS</h4>
                <div class="text-dark">
                    <span id="fechaActual">ðŸ“… Fecha: --/--/----</span><br>
                    <span id="horaActual">ðŸ•’ Hora: --:--</span>
                </div>
            </div>
            <div>
                <a href="/" class="btn btn-primary">Volver al Mapa</a>
            </div>
        </div>
        <div class="card-body">
            <div class="resumen-container bg-light p-3 rounded" style="font-family: 'Segoe UI', Arial, sans-serif;">
                <div class="d-flex justify-content-between border-bottom border-dark py-2">
                    <span>ðŸ’° Total dÃ­a: $<span id="resumenTotal">0</span></span>
                    <span>ðŸ“Š Pedidos: <span id="resumenPedidos">0</span></span>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table table-bordered table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>HORA</th>
                                <th>PRODUCTO</th>
                                <th>CANT</th>
                                <th>P.UNIT</th>
                                <th>TOTAL</th>
                                <th>PAGO</th>
                            </tr>
                        </thead>
                        <tbody id="resumenTabla">
                            <!-- Se llenarÃ¡ dinÃ¡micamente -->
                        </tbody>
                    </table>
                </div>
                <div class="border-top border-dark pt-2">
                    <div class="row">
                        <div class="col-md-6">
                            <p>ðŸ’µ EFECTIVO: $<span id="totalEfectivo">0</span></p>
                        </div>
                        <div class="col-md-6">
                            <p>ðŸ’³ TARJETA: $<span id="totalTarjeta">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function actualizarFechaHora() {
    const ahora = new Date();
    const opciones = { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    };
    
    // Formatear fecha como DD/MM/YYYY
    const dia = ahora.getDate().toString().padStart(2, '0');
    const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
    const aÃ±o = ahora.getFullYear();
    const fechaFormateada = `${dia}/${mes}/${aÃ±o}`;
    
    // Formatear hora en formato 24 horas
    const horaFormateada = ahora.toLocaleTimeString('es-AR', opciones);
    
    document.getElementById('fechaActual').textContent = `ðŸ“… Fecha: ${fechaFormateada}`;
    document.getElementById('horaActual').textContent = `ðŸ•’ Hora: ${horaFormateada}`;
}

function capitalizarMetodoPago(metodo) {
    return metodo.charAt(0).toUpperCase() + metodo.slice(1).toLowerCase();
}

function actualizarResumen() {
    fetch('/api/historial/diario')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const historial = data.historial;
                let totalDia = 0;
                let totalEfectivo = 0;
                let totalTarjeta = 0;
                let cantidadPedidos = 0;
                
                // Limpiar tabla
                const tabla = document.getElementById('resumenTabla');
                tabla.innerHTML = '';
                
                // Procesar cada ticket
                historial.forEach(ticket => {
                    // Procesar pedidos del ticket
                    Object.values(ticket.pedidos_por_cliente).forEach(cliente => {
                        cliente.pedidos.forEach(pedido => {
                            // Agregar fila a la tabla
                            const fila = document.createElement('tr');
                            fila.innerHTML = `
                                <td>${ticket.hora.substring(0, 5)}</td>
                                <td>${pedido.nombre}</td>
                                <td class="text-center">${pedido.cantidad}</td>
                                <td class="text-end">$${pedido.precio_unitario}</td>
                                <td class="text-end">$${pedido.precio_total}</td>
                                <td>${capitalizarMetodoPago(ticket.metodo_pago)}</td>
                            `;
                            tabla.appendChild(fila);
                            
                            // Actualizar totales
                            totalDia += pedido.precio_total;
                            cantidadPedidos += pedido.cantidad;
                            
                            // Actualizar totales por mÃ©todo de pago
                            switch(ticket.metodo_pago.toLowerCase()) {
                                case 'efectivo':
                                    totalEfectivo += pedido.precio_total;
                                    break;
                                case 'tarjeta':
                                    totalTarjeta += pedido.precio_total;
                                    break;
                            }
                        });
                    });
                });
                
                // Actualizar totales en la pÃ¡gina
                document.getElementById('resumenTotal').textContent = totalDia.toFixed(2);
                document.getElementById('resumenPedidos').textContent = cantidadPedidos;
                document.getElementById('totalEfectivo').textContent = `${totalEfectivo.toFixed(2)} (${((totalEfectivo/totalDia)*100).toFixed(1)}%)`;
                document.getElementById('totalTarjeta').textContent = `${totalTarjeta.toFixed(2)} (${((totalTarjeta/totalDia)*100).toFixed(1)}%)`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar fecha y hora
    actualizarFechaHora();
    // Actualizar la hora cada 2 segundos
    setInterval(actualizarFechaHora, 2000);
    
    // Cargar datos iniciales
    actualizarResumen();
    // Actualizar datos cada 2 segundos
    setInterval(actualizarResumen, 2000);
});
</script>
{% endblock %} 