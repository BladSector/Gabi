{% extends "base.html" %}

{% block title %}Vista Mozos - Sistema de Restaurante{% endblock %}

{% block content %}
<!-- Modal para gestionar pedidos de mesa -->
<div class="modal fade" id="pedidosMesaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestionar Pedidos - <span id="numeroMesaActual"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Men√∫</h6>
                            </div>
                            <div class="card-body">
                                <div class="list-group" id="listaMenu">
                                    <!-- El men√∫ se cargar√° din√°micamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Pedidos Pendientes</h6>
                            </div>
                            <div class="card-body">
                                <div id="pedidosPendientes">
                                    <!-- Los pedidos pendientes se cargar√°n din√°micamente -->
                                </div>
                                <button class="btn btn-success w-100 mt-3" onclick="enviarPedidosCocina()">
                                    Enviar a Cocina
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar tipo de caf√© -->
<div class="modal fade" id="tipoCafeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seleccionar tipo de caf√©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <button class="list-group-item list-group-item-action" onclick="seleccionarTipoCafe('Caf√©')">Caf√©</button>
                    <button class="list-group-item list-group-item-action" onclick="seleccionarTipoCafe('Cortado')">Cortado</button>
                    <button class="list-group-item list-group-item-action" onclick="seleccionarTipoCafe('L√°grima')">L√°grima</button>
                    <button class="list-group-item list-group-item-action" onclick="seleccionarTipoCafe('Con leche')">Con leche</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para nombre de cliente Take Away -->
<div class="modal fade" id="nombreClienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ingresar Nombre del Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="nombreCliente">Nombre del Cliente *</label>
                    <input type="text" class="form-control" id="nombreCliente" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarNombreCliente()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4>Mapa del Restaurante</h4>
                        <div class="text-muted">
                            <span id="fechaActual">üìÖ Fecha: --/--/----</span><br>
                            <span id="horaActual">üïí Hora: --:--</span>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="/resumen-diario" target="_blank" class="btn btn-primary">
                            üìä Resumen Diario
                        </a>
                        <button class="btn btn-outline-primary" onclick="cambiarModo()">
                            <span id="modoActual">Modo: Mozo</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-3 g-4" id="mapaMesas">
                        <!-- El contenido se actualizar√° autom√°ticamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Resumen Diario -->
<div class="modal fade" id="resumenDiarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resumen Diario de Ventas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="resumen-container bg-light p-3 rounded" style="font-family: 'Segoe UI', Arial, sans-serif;">
                    <div class="text-center border-bottom border-dark pb-2">
                        <h4>INFORME DE VENTAS DIARIAS</h4>
                    </div>
                    <div class="d-flex justify-content-between border-bottom border-dark py-2">
                        <span>üìÖ Fecha: <span id="resumenFecha">--/--/----</span></span>
                        <span>üïí Hora: <span id="resumenHora">--:--</span></span>
                    </div>
                    <div class="d-flex justify-content-between border-bottom border-dark py-2">
                        <span>üí∞ Total d√≠a: $<span id="resumenTotal">0</span></span>
                        <span>üìä Pedidos: <span id="resumenPedidos">0</span></span>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>HORA</th>
                                    <th>PRODUCTO</th>
                                    <th>CANT</th>
                                    <th>P.UNIT</th>
                                    <th>TOTAL</th>
                                    <th>PAGO</th>
                                </tr>
                            </thead>
                            <tbody id="resumenTabla">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    <div class="border-top border-dark pt-2">
                        <div class="row">
                            <div class="col-md-6">
                                <p>üíµ EFECTIVO: $<span id="totalEfectivo">0</span></p>
                            </div>
                            <div class="col-md-6">
                                <p>üí≥ TARJETA: $<span id="totalTarjeta">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

<script>
let esAdmin = false;
let mesaActual = null;
let pedidosPendientes = [];
let menuCompleto = [];
let platoSeleccionado = null;
let contadorPedidos = 0;
let clienteActual = null;
let esTakeAway = false;

function obtenerEmojiCategoria(nombrePlato) {
    // Productos de cafeter√≠a
    const productosCafeteria = ['Pocillo', 'Jarrito', 'Taza', 'Taz√≥n', 'Caf√© para llevar chico', 'Caf√© para llevar grande', 'Caf√©', 'Cortado', 'L√°grima', 'Con leche'];
    if (productosCafeteria.some(producto => nombrePlato.includes(producto))) {
        return '‚òï';
    }
    
    // Bebidas
    const bebidas = ['Agua', 'Gaseosa', 'Limonada', 'Jugo', 'T√©'];
    if (bebidas.some(bebida => nombrePlato.includes(bebida))) {
        return 'ü•§';
    }
    
    // Salados
    const salados = ['Sandwich', 'Tostado', 'Empanada', 'Pizza', 'Hamburguesa'];
    if (salados.some(salado => nombrePlato.includes(salado))) {
        return 'ü•™';
    }
    
    // Dulces
    const dulces = ['Torta', 'Alfajor', 'Galletas', 'Brownie', 'Muffin', 'Medialuna'];
    if (dulces.some(dulce => nombrePlato.includes(dulce))) {
        return 'üç∞';
    }
    
    // Combos
    const combos = ['Combo', 'Promo', 'Men√∫'];
    if (combos.some(combo => nombrePlato.includes(combo))) {
        return 'üçΩÔ∏è';
    }
    
    // Por defecto
    return 'üçΩÔ∏è';
}

document.addEventListener('DOMContentLoaded', function() {
    // Cargar mapa de mesas inicial
    actualizarMapaMesas();
    
    // Actualizaci√≥n autom√°tica cada 2 segundos
    setInterval(actualizarMapaMesas, 2000);

    // Iniciar actualizaci√≥n de fecha y hora
    actualizarFechaHora();
    // Actualizar la hora cada 2 segundos
    setInterval(actualizarFechaHora, 2000);
});

function cambiarModo() {
    esAdmin = !esAdmin;
    document.getElementById('modoActual').textContent = `Modo: ${esAdmin ? 'Admin' : 'Mozo'}`;
    actualizarMapaMesas();
}

function actualizarMapaMesas() {
    // Guardar el estado de los acordeones abiertos
    const acordeonesAbiertos = {};
    document.querySelectorAll('.accordion-collapse').forEach(acordeon => {
        if (acordeon.classList.contains('show')) {
            acordeonesAbiertos[acordeon.id] = true;
        }
    });

    fetch('/api/mozos/mapa-mesas')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('mapaMesas');
                container.innerHTML = data.data.map(mesa => {
                    // Filtrar pedidos pendientes
                    const pedidosPendientes = mesa.pedidos_en_cocina.filter(p => 
                        !p.estado_cocina.includes('üí∞')
                    );

                    // Verificar si hay pedidos pendientes
                    const tienePedidosPendientes = pedidosPendientes.length > 0;

                    // Agrupar pedidos por cliente para Take Away Barra
                    let contenidoPedidos = '';
                    if (mesa.nombre === 'Take Away Barra' && tienePedidosPendientes) {
                        const pedidosPorCliente = {};
                        pedidosPendientes.forEach(pedido => {
                            const cliente = pedido.cliente || 'Cliente sin nombre';
                            if (!pedidosPorCliente[cliente]) {
                                pedidosPorCliente[cliente] = [];
                            }
                            pedidosPorCliente[cliente].push(pedido);
                        });

                        contenidoPedidos = `
                            <div class="accordion mt-3" id="accordionMesa${mesa.id}" onclick="event.stopPropagation()">
                                ${Object.entries(pedidosPorCliente).map(([cliente, pedidosCliente], index) => `
                                    <div class="card mb-3 border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Cliente: ${cliente}</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            ${pedidosCliente.map(pedido => `
                                                <div class="card mb-2">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <h6 class="card-title mb-0">${obtenerEmojiCategoria(pedido.nombre)}</h6>
                                                            <small class="text-muted">${pedido.hora_envio}</small>
                                                        </div>
                                                        <p class="card-text mb-1">
                                                            ${pedido.cantidad}x ${pedido.nombre}
                                                        </p>
                                                        <p class="card-text mb-1">
                                                            <small>
                                                                Estado: ${pedido.estado_cocina}
                                                            </small>
                                                        </p>
                                                        ${pedido.notas && pedido.notas.length > 0 ? `
                                                            <div class="alert alert-info py-1 mb-1">
                                                                <small>üìù<br>${pedido.notas.map(n => `‚Ä¢ ${n.texto}`).join('<br>')}</small>
                                                            </div>
                                                        ` : ''}
                                                        ${esAdmin ? `<button class='btn btn-danger btn-sm w-100 mt-1' onclick='cancelarPedido(event, "${mesa.id}", "${pedido.id}")'>Cancelar Pedido</button>` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            <button class="btn btn-success w-100 mt-2" onclick='pagarCuentaCliente("${mesa.id}", "${cliente}")'>
                                                Pagar Cuenta de ${cliente}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${esAdmin ? `<button class='btn btn-warning btn-sm w-100 mt-2' onclick='reiniciarMesa(event, "${mesa.id}")'>Reiniciar Mesa</button>` : ''}
                        `;
                    } else if (tienePedidosPendientes) {
                        // Visualizaci√≥n para otras mesas con pedidos pendientes
                        contenidoPedidos = `
                            <div class="accordion mt-3" id="accordionMesa${mesa.id}" onclick="event.stopPropagation()">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button ${acordeonesAbiertos[`collapsePendientes${mesa.id}`] ? '' : 'collapsed'}" 
                                                type="button" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#collapsePendientes${mesa.id}">
                                            Pedidos Pendientes (${pedidosPendientes.length})
                                        </button>
                                    </h2>
                                    <div id="collapsePendientes${mesa.id}" 
                                         class="accordion-collapse collapse ${acordeonesAbiertos[`collapsePendientes${mesa.id}`] ? 'show' : ''}">
                                        <div class="accordion-body p-2">
                                            ${pedidosPendientes.map(pedido => `
                                                <div class="card mb-2">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <h6 class="card-title mb-0">${obtenerEmojiCategoria(pedido.nombre)}</h6>
                                                            <small class="text-muted">${pedido.hora_envio}</small>
                                                        </div>
                                                        <p class="card-text mb-1">
                                                            ${pedido.cantidad}x ${pedido.nombre}
                                                        </p>
                                                        <p class="card-text mb-1">
                                                            <small>Estado: ${pedido.estado_cocina}</small>
                                                        </p>
                                                        ${pedido.notas && pedido.notas.length > 0 ? `
                                                            <div class="alert alert-info py-1 mb-1">
                                                                <small>üìù<br>${pedido.notas.map(n => `‚Ä¢ ${n.texto}`).join('<br>')}</small>
                                                            </div>
                                                        ` : ''}
                                                        ${esAdmin ? `<button class='btn btn-danger btn-sm w-100 mt-1' onclick='cancelarPedido(event, "${mesa.id}", "${pedido.id}")'>Cancelar Pedido</button>` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class='btn btn-success btn-sm w-100' onclick='pagarCuenta("${mesa.id}")'>Pagar Cuenta</button>
                                ${esAdmin ? `<button class='btn btn-warning btn-sm w-100 mt-2' onclick='reiniciarMesa(event, "${mesa.id}")'>Reiniciar Mesa</button>` : ''}
                            </div>
                        `;
                    }

                    return `
                        <div class="col">
                            <div class="card h-100 ${tienePedidosPendientes ? 'border-warning' : 'border-success'}">
                                <div class="card-body" onclick="abrirGestionPedidos('${mesa.id}', '${mesa.nombre}')" style="cursor: pointer;">
                                    <h5 class="card-title">${mesa.nombre}</h5>
                                    <p class="card-text">
                                        <span class="badge ${tienePedidosPendientes ? 'bg-warning text-dark' : 'bg-success'}">
                                            ${tienePedidosPendientes ? 'Ocupada' : 'Libre'}
                                        </span>
                                    </p>
                                    ${contenidoPedidos}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                console.error('Error al cargar el mapa de mesas:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function resetearEstadoPedidos() {
    pedidosPendientes = [];
    clienteActual = null;
    contadorPedidos = 0;
    platoSeleccionado = null;
    esTakeAway = false;
}

function abrirGestionPedidos(mesaId, mesaNombre) {
    // Resetear estado si cambiamos de mesa
    if (mesaActual !== mesaId) {
        resetearEstadoPedidos();
    }
    
    mesaActual = mesaId;
    esTakeAway = mesaNombre === 'Take Away Barra';
    document.getElementById('numeroMesaActual').textContent = mesaNombre;
    
    // Si es Take Away Barra, pedir nombre del cliente
    if (esTakeAway) {
        const nombreClienteModal = new bootstrap.Modal(document.getElementById('nombreClienteModal'));
        nombreClienteModal.show();
        return;
    }
    
    continuarAbrirGestionPedidos();
}

function confirmarNombreCliente() {
    const nombreCliente = document.getElementById('nombreCliente').value.trim();
    if (!nombreCliente) {
        Swal.fire({
            title: 'Error',
            text: 'El nombre del cliente es obligatorio para Take Away',
            icon: 'error',
            confirmButtonText: 'Aceptar'
        });
        return;
    }
    
    clienteActual = nombreCliente;
    bootstrap.Modal.getInstance(document.getElementById('nombreClienteModal')).hide();
    continuarAbrirGestionPedidos();
    
    // Limpiar el campo para futuros usos
    document.getElementById('nombreCliente').value = '';
}

function continuarAbrirGestionPedidos() {
    // Cargar el men√∫
    fetch('/api/menu')
        .then(response => response.json())
        .then(data => {
            menuCompleto = data.menu;
            const listaMenu = document.getElementById('listaMenu');
            
            // Funci√≥n para generar el HTML de una categor√≠a
            const generarCategoriaHTML = (titulo, platos, emoji) => {
                console.log(`Generando categor√≠a ${titulo}:`, platos); // Log para cada categor√≠a
                return `
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">${emoji} ${titulo}</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                ${platos.map(plato => `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">${plato.nombre}</h6>
                                                ${plato.descripcion && plato.descripcion.length > 0 ? `
                                                    <p class="text-muted mb-1 small">${plato.descripcion.join(' | ')}</p>
                                                ` : ''}
                                                <small class="text-muted">$${plato.precio}</small>
                                            </div>
                                            <button class="btn btn-primary btn-sm ms-2" onclick="agregarPedido('${plato.id}')">
                                                Agregar
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            };

            // Generar el HTML completo del men√∫
            const menuHTML = `
                ${menuCompleto.combos ? generarCategoriaHTML('Combos', menuCompleto.combos, 'üçΩÔ∏è') : ''}
                ${menuCompleto.cafeteria ? generarCategoriaHTML('Cafeter√≠a', menuCompleto.cafeteria, '‚òï') : ''}
                ${menuCompleto.bebidas ? generarCategoriaHTML('Bebidas', menuCompleto.bebidas, 'ü•§') : ''}
                ${menuCompleto.salados ? generarCategoriaHTML('Salados', menuCompleto.salados, 'ü•™') : ''}
                ${menuCompleto.dulces ? generarCategoriaHTML('Dulces', menuCompleto.dulces, 'üç∞') : ''}
            `;
            
            console.log('HTML generado:', menuHTML); // Log para ver el HTML generado
            listaMenu.innerHTML = menuHTML;
            
            // Mostrar el modal
            const pedidosMesaModal = new bootstrap.Modal(document.getElementById('pedidosMesaModal'));
            
            // Agregar evento para limpiar estado al cerrar el modal
            document.getElementById('pedidosMesaModal').addEventListener('hidden.bs.modal', function () {
                resetearEstadoPedidos();
                actualizarPedidosPendientes();
            });
            
            pedidosMesaModal.show();
        })
        .catch(error => {
            console.error('Error al cargar el men√∫:', error);
        });
}

function agregarPedido(platoId) {
    // Buscar el plato en todas las categor√≠as
    let platoEncontrado = null;
    for (const categoria in menuCompleto) {
        const plato = menuCompleto[categoria].find(p => p.id === parseInt(platoId));
        if (plato) {
            platoEncontrado = plato;
            break;
        }
    }

    if (!platoEncontrado) return;

    // Verificar si es un producto de cafeter√≠a
    const productosCafeteria = ['Pocillo', 'Jarrito', 'Taza', 'Taz√≥n', 'Caf√© para llevar chico', 'Caf√© para llevar grande'];
    
    if (productosCafeteria.includes(platoEncontrado.nombre)) {
        platoSeleccionado = platoEncontrado;
        const tipoCafeModal = new bootstrap.Modal(document.getElementById('tipoCafeModal'));
        tipoCafeModal.show();
    } else {
        agregarPedidoConNota(platoEncontrado);
    }
}

function seleccionarTipoCafe(tipo) {
    if (platoSeleccionado) {
        agregarPedidoConNota(platoSeleccionado, tipo);
        platoSeleccionado = null;
        bootstrap.Modal.getInstance(document.getElementById('tipoCafeModal')).hide();
    }
}

function agregarPedidoConNota(plato, nota = null) {
    // Validar que haya nombre de cliente para Take Away
    if (esTakeAway && !clienteActual) {
        Swal.fire({
            title: 'Error',
            text: 'Es necesario ingresar el nombre del cliente para Take Away',
            icon: 'error',
            confirmButtonText: 'Aceptar'
        });
        return;
    }

    const pedido = {
        id: `${Date.now()}_${contadorPedidos++}`,
        plato_id: plato.id,
        nombre: plato.nombre,
        precio: plato.precio,
        cantidad: 1,
        estado: 'pendiente',
        cliente: clienteActual || 'Mesa General'
    };

    if (nota) {
        pedido.notas = [{
            texto: `Tipo: ${nota}`,
            hora: new Date().toLocaleTimeString()
        }];
    }
    
    pedidosPendientes.push(pedido);
    actualizarPedidosPendientes();
    
    // Mostrar feedback de √©xito
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
    });

    Toast.fire({
        icon: 'success',
        title: `‚úÖ ${pedido.cantidad}x ${pedido.nombre} agregado`
    });
}

function actualizarPedidosPendientes() {
    const contenedor = document.getElementById('pedidosPendientes');
    if (pedidosPendientes.length === 0) {
        contenedor.innerHTML = '<p class="text-muted">No hay pedidos pendientes</p>';
        return;
    }
    
    // Agrupar pedidos por cliente
    const pedidosPorCliente = {};
    pedidosPendientes.forEach(pedido => {
        const cliente = pedido.cliente || 'Mesa General';
        if (!pedidosPorCliente[cliente]) {
            pedidosPorCliente[cliente] = [];
        }
        pedidosPorCliente[cliente].push(pedido);
    });
    
    contenedor.innerHTML = Object.entries(pedidosPorCliente).map(([cliente, pedidos]) => `
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Cliente: ${cliente}</h6>
            </div>
            <div class="card-body p-2">
                ${pedidos.map(pedido => `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${pedido.nombre}</h6>
                                    ${pedido.notas && pedido.notas.length > 0 ? 
                                        `<small class="text-primary">${pedido.notas[0].texto}</small>` : ''}
                                    <small class="text-muted d-block">
                                        Precio unitario: $${pedido.precio} | 
                                        Total: $${(pedido.precio * pedido.cantidad).toFixed(2)}
                                    </small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <input type="number" class="form-control form-control-sm me-2" 
                                           style="width: 60px" value="${pedido.cantidad}" 
                                           onchange="actualizarCantidad('${pedido.id}', this.value)">
                                    <button class="btn btn-danger btn-sm" onclick="eliminarPedidoPendiente('${pedido.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function eliminarPedidoPendiente(pedidoId) {
    pedidosPendientes = pedidosPendientes.filter(p => p.id !== pedidoId);
    actualizarPedidosPendientes();
}

function actualizarCantidad(pedidoId, nuevaCantidad) {
    const pedido = pedidosPendientes.find(p => p.id === pedidoId);
    if (pedido) {
        // Mantener el precio unitario original y solo actualizar la cantidad
        pedido.cantidad = Math.max(1, parseInt(nuevaCantidad) || 1);
        actualizarPedidosPendientes();
    }
}

function cancelarPedido(event, mesaId, pedidoId) {
    event.stopPropagation();
    Swal.fire({
        title: 'Confirmar',
        text: '¬øEst√° seguro que desea cancelar este pedido?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, cancelar',
        cancelButtonText: 'No'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/mozos/pedidos/${pedidoId}/cancelar`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mesa_id: mesaId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarMapaMesas();
                    Swal.fire({
                        title: '¬°√âxito!',
                        text: 'Pedido cancelado correctamente',
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: 'Error al cancelar el pedido: ' + data.error,
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al cancelar el pedido',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            });
        }
    });
}

function enviarPedidosCocina() {
    if (pedidosPendientes.length === 0) {
        Swal.fire({
            title: 'Atenci√≥n',
            text: 'No hay pedidos para enviar',
            icon: 'warning',
            confirmButtonText: 'Aceptar'
        });
        return;
    }

    // Validar nombre de cliente para Take Away
    if (esTakeAway) {
        const pedidosSinCliente = pedidosPendientes.some(p => !p.cliente || p.cliente === 'Mesa General');
        if (pedidosSinCliente) {
            Swal.fire({
                title: 'Error',
                text: 'Todos los pedidos de Take Away deben tener un nombre de cliente',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
            return;
        }
    }
    
    // Asegurarnos de que los pedidos tengan el cliente asignado y mantener precios unitarios
    const pedidosConCliente = pedidosPendientes.map(pedido => ({
        ...pedido,
        cliente: pedido.cliente || clienteActual || 'Mesa General',
        precio_unitario: pedido.precio,  // Mantener referencia expl√≠cita al precio unitario
        precio_total: pedido.precio * pedido.cantidad  // Calcular precio total
    }));
    
    fetch(`/api/mesas/${mesaActual}/enviar-cocina`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            pedidos: pedidosConCliente,
            mozo: esAdmin ? 'Admin' : 'Mozo'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resetearEstadoPedidos();
            // Cerrar el modal
            bootstrap.Modal.getInstance(document.getElementById('pedidosMesaModal')).hide();
            // Actualizar el mapa de mesas
            actualizarMapaMesas();
            
            // Mostrar notificaci√≥n toast
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            Toast.fire({
                icon: 'success',
                title: '‚úÖ Pedidos enviados correctamente'
            });
        } else {
            Swal.fire({
                title: 'Error',
                text: data.error || 'Error al enviar pedidos',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error',
            text: 'Error al enviar pedidos',
            icon: 'error',
            confirmButtonText: 'Aceptar'
        });
    });
}

function reiniciarMesa(event, mesaId) {
    event.stopPropagation();
    Swal.fire({
        title: 'Confirmar',
        text: '¬øEst√° seguro que desea reiniciar esta mesa?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, reiniciar',
        cancelButtonText: 'No'
    }).then((result) => {
        if (result.isConfirmed) {
        fetch(`/api/mozos/mesas/${mesaId}/reiniciar`, {
            method: 'PUT'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                actualizarMapaMesas();
                    Swal.fire({
                        title: '¬°√âxito!',
                        text: 'Mesa reiniciada correctamente',
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    });
            } else {
                    Swal.fire({
                        title: 'Error',
                        text: 'Error al reiniciar la mesa: ' + data.error,
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                    });
            }
        })
        .catch(error => {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al reiniciar la mesa',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            });
        }
    });
}

function pagarCuenta(mesaId) {
    event.stopPropagation();
    
    fetch(`/api/mozos/mesas/${mesaId}/pedidos`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al obtener los pedidos: ' + data.error,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            const pedidosPendientes = data.pedidos.filter(p => 
                p.estado_cocina === 'üü° Pendiente' && !p.estado_cocina.includes('üî¥')
            );

            if (pedidosPendientes.length === 0) {
                Swal.fire({
                    title: 'Atenci√≥n',
                    text: 'No hay pedidos pendientes para pagar',
                    icon: 'warning',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Agrupar pedidos por cliente
            const pedidosPorCliente = {};
            pedidosPendientes.forEach(pedido => {
                const cliente = pedido.cliente || 'Mesa General';
                if (!pedidosPorCliente[cliente]) {
                    pedidosPorCliente[cliente] = [];
                }
                
                // Desglosar pedidos con cantidad > 1 en √≠tems individuales
                for (let i = 0; i < pedido.cantidad; i++) {
                    const itemIndividual = {
                        ...pedido,
                        cantidad_original: pedido.cantidad,
                        cantidad: 1,
                        precio_individual: pedido.precio,  // Mantener precio unitario original
                        item_index: i + 1
                    };
                    pedidosPorCliente[cliente].push(itemIndividual);
                }
            });

            // Crear modal de pago con agrupaci√≥n por cliente
            const modalPago = `
                <div class="modal fade" id="modalPago" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Pagar Cuenta</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${Object.entries(pedidosPorCliente).map(([cliente, pedidos]) => `
                                    <div class="card mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <div class="form-check">
                                                <input class="form-check-input cliente-check" type="checkbox" 
                                                       value="${cliente}" id="cliente_${cliente}"
                                                       onchange="toggleClientePedidos('${cliente}')" checked>
                                                <label class="form-check-label text-white" for="cliente_${cliente}">
                                                    ${cliente}
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="list-group">
                                                ${pedidos.map(pedido => `
                                                    <div class="list-group-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input pedido-check" type="checkbox" 
                                                                   value="${pedido.id}" 
                                                                   id="pedido_${pedido.id}_${pedido.item_index}" 
                                                                   data-cliente="${cliente}"
                                                                   data-precio="${pedido.precio_individual}"
                                                                   data-item-index="${pedido.item_index}"
                                                                   data-cantidad-original="${pedido.cantidad_original}"
                                                                   checked
                                                                   onchange="actualizarTotal()">
                                                            <label class="form-check-label" for="pedido_${pedido.id}_${pedido.item_index}">
                                                                ${pedido.nombre} - $${pedido.precio_individual}
                                                                ${pedido.cantidad_original > 1 ? 
                                                                    `<small class="text-muted">(√çtem ${pedido.item_index} de ${pedido.cantidad_original})</small>` : 
                                                                    ''}
                                                                ${pedido.notas ? `<br><small class="text-primary">${pedido.notas.map(n => n.texto).join(', ')}</small>` : ''}
                                                            </label>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                                <div class="mb-3">
                                    <h6>M√©todo de Pago:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo" checked>
                                        <label class="form-check-label" for="efectivo">Efectivo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta">
                                        <label class="form-check-label" for="tarjeta">Tarjeta</label>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <h6 class="mb-0">Total a pagar: $<span id="totalPagar">0</span></h6>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="procesarPago('${mesaId}')">Pagar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalPago);
            const modal = new bootstrap.Modal(document.getElementById('modalPago'));
            modal.show();
            actualizarTotal();

            document.getElementById('modalPago').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al cargar los pedidos',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        });
}

function actualizarTotal() {
    const checkboxes = document.querySelectorAll('.pedido-check:checked');
    let total = 0;
    
    checkboxes.forEach(checkbox => {
        total += parseFloat(checkbox.dataset.precio);
    });
    
    document.getElementById('totalPagar').textContent = total.toFixed(2);
}

function procesarPago(mesaId) {
    // Obtener pedidos seleccionados y agruparlos
    const pedidosSeleccionados = {};
    
    Array.from(document.querySelectorAll('.pedido-check:checked')).forEach(checkbox => {
        const id = checkbox.value;
        const itemIndex = parseInt(checkbox.dataset.itemIndex);
        const cantidadOriginal = parseInt(checkbox.dataset.cantidadOriginal);
        
        if (!pedidosSeleccionados[id]) {
            pedidosSeleccionados[id] = {
                items: new Set(),
                cantidadOriginal: cantidadOriginal
            };
        }
        pedidosSeleccionados[id].items.add(itemIndex);
    });
    
    // Convertir a formato para enviar al servidor
    const pedidosParaPagar = Object.entries(pedidosSeleccionados).map(([id, data]) => ({
        id: id,
        cantidad: data.items.size
    }));

    if (pedidosParaPagar.length === 0) {
        Swal.fire({
            title: 'Atenci√≥n',
            text: 'Debe seleccionar al menos un √≠tem para pagar',
            icon: 'warning',
            confirmButtonText: 'Aceptar'
        });
        return;
    }

    // Obtener m√©todo de pago
    const metodoPago = document.querySelector('input[name="metodoPago"]:checked').value;

    const datosPago = {
        mozo: esAdmin ? 'Admin' : 'Mozo',
        pedidos_ids: pedidosParaPagar,
        metodo_pago: metodoPago
    };

    // Realizar el pago
    fetch(`/api/mozos/mesas/${mesaId}/pagar`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datosPago)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal de pago inmediatamente
            bootstrap.Modal.getInstance(document.getElementById('modalPago')).hide();
            
            // Mostrar notificaci√≥n toast
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            Toast.fire({
                icon: 'success',
                title: `‚úÖ Cuenta pagada: $${data.total}`
            });
            
            // Actualizar mapa de mesas
            actualizarMapaMesas();
        } else {
            Swal.fire({
                title: 'Error',
                text: 'Error al pagar la cuenta: ' + data.error,
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error',
            text: 'Error al procesar el pago',
            icon: 'error',
            confirmButtonText: 'Aceptar'
        });
    });
}

function toggleClientePedidos(cliente) {
    const clienteCheck = document.getElementById(`cliente_${cliente}`);
    const pedidosCliente = document.querySelectorAll(`.pedido-check[data-cliente="${cliente}"]`);
    
    pedidosCliente.forEach(pedido => {
        pedido.checked = clienteCheck.checked;
    });
    
    actualizarTotal();
}

function pagarCuentaCliente(mesaId, cliente) {
    event.stopPropagation();
    
    fetch(`/api/mozos/mesas/${mesaId}/pedidos`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al obtener los pedidos: ' + data.error,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Filtrar solo los pedidos del cliente espec√≠fico
            const pedidosCliente = data.pedidos.filter(p => 
                p.estado_cocina === 'üü° Pendiente' && 
                !p.estado_cocina.includes('üî¥') &&
                p.cliente === cliente
            );

            if (pedidosCliente.length === 0) {
                Swal.fire({
                    title: 'Atenci√≥n',
                    text: 'No hay pedidos pendientes para este cliente',
                    icon: 'warning',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Desglosar pedidos con cantidad > 1 en √≠tems individuales
            const pedidosDesglosados = [];
            pedidosCliente.forEach(pedido => {
                for (let i = 0; i < pedido.cantidad; i++) {
                    pedidosDesglosados.push({
                        ...pedido,
                        cantidad_original: pedido.cantidad,
                        cantidad: 1,
                        precio_individual: pedido.precio,  // Mantener precio unitario original
                        item_index: i + 1
                    });
                }
            });

            // Crear modal de pago espec√≠fico para el cliente
            const modalPago = `
                <div class="modal fade" id="modalPago" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Pagar Cuenta - ${cliente}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">Pedidos de ${cliente}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group">
                                            ${pedidosDesglosados.map(pedido => `
                                                <div class="list-group-item">
                                                    <div class="form-check">
                                                        <input class="form-check-input pedido-check" type="checkbox" 
                                                               value="${pedido.id}" 
                                                               id="pedido_${pedido.id}_${pedido.item_index}"
                                                               data-cliente="${cliente}"
                                                               data-precio="${pedido.precio_individual}"
                                                               data-item-index="${pedido.item_index}"
                                                               data-cantidad-original="${pedido.cantidad_original}"
                                                               checked
                                                               onchange="actualizarTotal()">
                                                        <label class="form-check-label" for="pedido_${pedido.id}_${pedido.item_index}">
                                                            ${pedido.nombre} - $${pedido.precio_individual}
                                                            ${pedido.cantidad_original > 1 ? 
                                                                `<small class="text-muted">(√çtem ${pedido.item_index} de ${pedido.cantidad_original})</small>` : 
                                                                ''}
                                                            ${pedido.notas ? `<br><small class="text-primary">${pedido.notas.map(n => n.texto).join(', ')}</small>` : ''}
                                                        </label>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 mt-3">
                                    <h6>M√©todo de Pago:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo" checked>
                                        <label class="form-check-label" for="efectivo">Efectivo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta">
                                        <label class="form-check-label" for="tarjeta">Tarjeta</label>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <h6 class="mb-0">Total a pagar: $<span id="totalPagar">0</span></h6>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="procesarPago('${mesaId}')">Pagar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalPago);
            const modal = new bootstrap.Modal(document.getElementById('modalPago'));
            modal.show();
            actualizarTotal();

            document.getElementById('modalPago').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al cargar los pedidos',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        });
}

// Agregar el modal de confirmaci√≥n al cerrar
document.addEventListener('DOMContentLoaded', function() {
    const pedidosMesaModal = document.getElementById('pedidosMesaModal');
    
    pedidosMesaModal.addEventListener('hide.bs.modal', function (event) {
        if (pedidosPendientes.length > 0) {
            event.preventDefault();
            Swal.fire({
                title: '¬øEst√° seguro?',
                text: 'Hay pedidos sin enviar. Si cierra se perder√°n los cambios.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, cerrar',
                cancelButtonText: 'No, continuar'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetearEstadoPedidos();
                    bootstrap.Modal.getInstance(pedidosMesaModal).hide();
                }
            });
        }
    });
});

function mostrarResumenDiario() {
    // Obtener la fecha actual
    const fecha = new Date();
    const fechaFormateada = fecha.toLocaleDateString('es-AR');
    const horaFormateada = fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', second: undefined, hour12: false });
    
    // Actualizar fecha y hora en el modal
    document.getElementById('resumenFecha').textContent = fechaFormateada;
    document.getElementById('resumenHora').textContent = horaFormateada;
    
    // Obtener el historial del d√≠a
    fetch('/api/historial/diario')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const historial = data.historial;
                let totalDia = 0;
                let totalEfectivo = 0;
                let totalTarjeta = 0;
                let cantidadPedidos = 0;
                
                // Limpiar tabla
                const tabla = document.getElementById('resumenTabla');
                tabla.innerHTML = '';
                
                // Procesar cada ticket
                historial.forEach(ticket => {
                    // Procesar pedidos del ticket
                    Object.values(ticket.pedidos_por_cliente).forEach(cliente => {
                        cliente.pedidos.forEach(pedido => {
                            // Agregar fila a la tabla
                            const fila = document.createElement('tr');
                            fila.innerHTML = `
                                <td>${ticket.hora.substring(0, 5)}</td>
                                <td>${pedido.nombre}</td>
                                <td class="text-center">${pedido.cantidad}</td>
                                <td class="text-end">$${pedido.precio_unitario}</td>
                                <td class="text-end">$${pedido.precio_total}</td>
                                <td>${capitalizarMetodoPago(ticket.metodo_pago)}</td>
                            `;
                            tabla.appendChild(fila);
                            
                            // Actualizar totales
                            totalDia += pedido.precio_total;
                            cantidadPedidos += pedido.cantidad;
                            
                            // Actualizar totales por m√©todo de pago
                            switch(ticket.metodo_pago.toLowerCase()) {
                                case 'efectivo':
                                    totalEfectivo += pedido.precio_total;
                                    break;
                                case 'tarjeta':
                                    totalTarjeta += pedido.precio_total;
                                    break;
                            }
                        });
                    });
                });
                
                // Actualizar totales en el modal
                document.getElementById('resumenTotal').textContent = totalDia.toFixed(2);
                document.getElementById('resumenPedidos').textContent = cantidadPedidos;
                document.getElementById('totalEfectivo').textContent = `${totalEfectivo.toFixed(2)} (${((totalEfectivo/totalDia)*100).toFixed(1)}%)`;
                document.getElementById('totalTarjeta').textContent = `${totalTarjeta.toFixed(2)} (${((totalTarjeta/totalDia)*100).toFixed(1)}%)`;
            } else {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al cargar el historial: ' + data.error,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al cargar el historial',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        });
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('resumenDiarioModal'));
    modal.show();
}

function capitalizarMetodoPago(metodo) {
    return metodo.charAt(0).toUpperCase() + metodo.slice(1).toLowerCase();
}

function actualizarFechaHora() {
    const ahora = new Date();
    const opciones = { 
        hour: '2-digit', 
        minute: '2-digit', 
        hour12: false 
    };
    
    // Formatear fecha como DD/MM/YYYY
    const dia = ahora.getDate().toString().padStart(2, '0');
    const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
    const a√±o = ahora.getFullYear();
    const fechaFormateada = `${dia}/${mes}/${a√±o}`;
    
    // Formatear hora en formato 24 horas
    const horaFormateada = ahora.toLocaleTimeString('es-AR', opciones);
    
    document.getElementById('fechaActual').textContent = `üìÖ Fecha: ${fechaFormateada}`;
    document.getElementById('horaActual').textContent = `üïí Hora: ${horaFormateada}`;
}
</script>
{% endblock %} 