{% extends "base.html" %}

{% block title %}Vista Mozos - Sistema de Restaurante{% endblock %}

{% block content %}
<!-- Modal para gestionar pedidos -->
<div class="modal fade" id="pedidosMesaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üçΩÔ∏è Gestionar Pedidos - <span id="numeroMesaActual"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <!-- Campo de b√∫squeda -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">üîç</span>
                            <input type="text" class="form-control" id="buscarPlato" placeholder="Buscar platos..." onkeyup="filtrarPlatos(this.value)">
                            </div>
                        <!-- Lista del men√∫ -->
                        <div id="listaMenu">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Pedidos Pendientes</h5>
                            </div>
                            <div class="card-body p-2">
                                <!-- Contenedor de pedidos pendientes -->
                                <div id="pedidosPendientesContainer">
                                    <p class="text-muted text-center">No hay pedidos pendientes</p>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary w-100" onclick="enviarPedidosCocina()">
                                    Enviar a Cocina
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar tipo de caf√© -->
<div class="modal fade" id="tipoCafeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">¬øC√≥mo lo vas a querer? ‚òï</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row row-cols-1 row-cols-md-2 g-3">
                    <div class="col">
                        <button class="btn btn-outline-primary w-100 h-100 p-3 d-flex flex-column align-items-center gap-2" 
                                onclick="seleccionarTipoCafe('Caf√© solo')">
                            <span style="font-size: 2rem;">‚òï</span>
                            <span>Caf√© solo</span>
                            <small class="text-muted">Caf√© puro</small>
                        </button>
                </div>
                    <div class="col">
                        <button class="btn btn-outline-primary w-100 h-100 p-3 d-flex flex-column align-items-center gap-2" 
                                onclick="seleccionarTipoCafe('Cortado')">
                            <span style="font-size: 2rem;">‚òï</span>
                            <span>Cortado</span>
                            <small class="text-muted">Caf√© con un poco de leche</small>
                        </button>
            </div>
                    <div class="col">
                        <button class="btn btn-outline-primary w-100 h-100 p-3 d-flex flex-column align-items-center gap-2" 
                                onclick="seleccionarTipoCafe('L√°grima')">
                            <span style="font-size: 2rem;">ü•õ</span>
                            <span>L√°grima</span>
                            <small class="text-muted">Leche con un poco de caf√©</small>
                        </button>
                    </div>
                    <div class="col">
                        <button class="btn btn-outline-primary w-100 h-100 p-3 d-flex flex-column align-items-center gap-2" 
                                onclick="seleccionarTipoCafe('Caf√© con leche')">
                            <span style="font-size: 2rem;">‚òïü•õ</span>
                            <span>Caf√© con leche</span>
                            <small class="text-muted">Mitad caf√©, mitad leche</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para nombre de cliente Take Away -->
<div class="modal fade" id="nombreClienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ingresar Nombre del Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="nombreCliente">Nombre del Cliente *</label>
                    <input type="text" class="form-control" id="nombreCliente" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarNombreCliente()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4>Mapa del Restaurante</h4>
                        <div class="text-muted">
                            <span id="fechaActual">üìÖ Fecha: --/--/----</span><br>
                            <span id="horaActual">üïí Hora: --:--</span>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="/resumen-diario" target="_blank" class="btn btn-primary">
                            üìä Resumen Diario
                        </a>
                        <button class="btn btn-outline-primary" onclick="cambiarModo()">
                            <span id="modoActual">Modo: Mozo</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-3 g-4" id="mapaMesas">
                        <!-- El contenido se actualizar√° autom√°ticamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Resumen Diario -->
<div class="modal fade" id="resumenDiarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resumen Diario de Ventas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="resumen-container bg-light p-3 rounded" style="font-family: 'Segoe UI', Arial, sans-serif;">
                    <div class="text-center border-bottom border-dark pb-2">
                        <h4>INFORME DE VENTAS DIARIAS</h4>
                    </div>
                    <div class="d-flex justify-content-between border-bottom border-dark py-2">
                        <span>üìÖ Fecha: <span id="resumenFecha">--/--/----</span></span>
                        <span>üïí Hora: <span id="resumenHora">--:--</span></span>
                    </div>
                    <div class="d-flex justify-content-between border-bottom border-dark py-2">
                        <span>üí∞ Total d√≠a: $<span id="resumenTotal">0</span></span>
                        <span>üìä Pedidos: <span id="resumenPedidos">0</span></span>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>HORA</th>
                                    <th>PRODUCTO</th>
                                    <th>CANT</th>
                                    <th>P.UNIT</th>
                                    <th>TOTAL</th>
                                    <th>PAGO</th>
                                </tr>
                            </thead>
                            <tbody id="resumenTabla">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    <div class="border-top border-dark pt-2">
                        <div class="row">
                            <div class="col-md-6">
                                <p>üíµ EFECTIVO: $<span id="totalEfectivo">0</span></p>
                            </div>
                            <div class="col-md-6">
                                <p>üí≥ TARJETA: $<span id="totalTarjeta">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

<script>
let esAdmin = false;
let mesaActual = null;
let pedidosPendientes = [];
let menuCompleto = [];
let platoSeleccionado = null;
let contadorPedidos = 0;
let clienteActual = null;
let esTakeAway = false;

function obtenerEmojiCategoria(nombrePlato) {
    // Empanadas
    const empanadas = ['Empanada', 'Empanadas'];
    if (empanadas.some(item => nombrePlato.toLowerCase().includes(item.toLowerCase()))) {
        return 'ü•ü';
    }
    
    // S√°ndwiches y tostados
    const sandwiches = ['Sandwich', 'S√°ndwich', 'Tostado', 'Hamburguesa'];
    if (sandwiches.some(item => nombrePlato.toLowerCase().includes(item.toLowerCase()))) {
        return 'ü•™';
    }

    // Productos de cafeter√≠a
    const productosCafeteria = ['Pocillo', 'Jarrito', 'Taza', 'Taz√≥n', 'Caf√©', 'Cortado', 'L√°grima', 'Capuccino', 'Latte'];
    if (productosCafeteria.some(producto => nombrePlato.toLowerCase().includes(producto.toLowerCase()))) {
        return '‚òï';
    }
    
    // Bebidas fr√≠as
    const bebidasFrias = ['Agua', 'Gaseosa', 'Limonada', 'Jugo', 'Licuado'];
    if (bebidasFrias.some(bebida => nombrePlato.toLowerCase().includes(bebida.toLowerCase()))) {
        return 'ü•§';
    }

    // T√© y bebidas calientes
    const bebidasCalientes = ['T√©', 'Chocolate'];
    if (bebidasCalientes.some(bebida => nombrePlato.toLowerCase().includes(bebida.toLowerCase()))) {
        return 'ü´ñ';
    }
    
    // Ensaladas
    const ensaladas = ['Ensalada', 'Caesar', 'Cesar'];
    if (ensaladas.some(item => nombrePlato.toLowerCase().includes(item.toLowerCase()))) {
        return 'ü•ó';
    }
    
    // Dulces y postres
    const dulces = ['Torta', 'Alfajor', 'Galletas', 'Brownie', 'Muffin', 'Medialuna', 'Cookie'];
    if (dulces.some(dulce => nombrePlato.toLowerCase().includes(dulce.toLowerCase()))) {
        return 'üç∞';
    }
    
    // Combos
    const combos = ['Combo', 'Promo', 'Men√∫'];
    if (combos.some(combo => nombrePlato.toLowerCase().includes(combo.toLowerCase()))) {
        return 'üçΩÔ∏è';
    }

    // Toast y tostadas
    const tostadas = ['Toast', 'Tostada'];
    if (tostadas.some(item => nombrePlato.toLowerCase().includes(item.toLowerCase()))) {
        return 'üçû';
    }
    
    // Por defecto
    return 'üçΩÔ∏è';
}

document.addEventListener('DOMContentLoaded', function() {
    // Cargar mapa de mesas inicial
    actualizarMapaMesas();
    
    // Actualizaci√≥n autom√°tica cada 2 segundos
    setInterval(actualizarMapaMesas, 2000);

    // Iniciar actualizaci√≥n de fecha y hora
    actualizarFechaHora();
    // Actualizar la hora cada 2 segundos
    setInterval(actualizarFechaHora, 2000);

    // Actualizar el texto del bot√≥n de modo al inicio
    document.getElementById('modoActual').textContent = `Modo: ${esAdmin ? 'Admin' : 'Normal'}`;
});

function cambiarModo() {
    esAdmin = !esAdmin;
    document.getElementById('modoActual').textContent = `Modo: ${esAdmin ? 'Admin' : 'Normal'}`;
    actualizarMapaMesas();
}

function actualizarMapaMesas() {
    // Guardar el estado de los acordeones abiertos
    const acordeonesAbiertos = {};
    document.querySelectorAll('.accordion-collapse').forEach(acordeon => {
        if (acordeon.classList.contains('show')) {
            acordeonesAbiertos[acordeon.id] = true;
        }
    });

    fetch('/api/mozos/mapa-mesas')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('mapaMesas');
                container.innerHTML = data.data.map(mesa => {
                    // Filtrar pedidos pendientes
                    const pedidosPendientes = mesa.pedidos_en_cocina.filter(p => 
                        !p.estado_cocina.includes('üí∞')
                    );

                    // Calcular el total de items pendientes (sumando las cantidades)
                    const totalItemsPendientes = pedidosPendientes.reduce((total, pedido) => 
                        total + (pedido.cantidad || 1), 0
                    );

                    // Verificar si hay pedidos pendientes
                    const tienePedidosPendientes = totalItemsPendientes > 0;

                    // Funci√≥n para formatear el nombre del pedido
                    const formatearNombrePedido = (pedido) => {
                        const esCafe = pedido.nombre.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes('cafe') || 
                                     ['pocillo', 'jarrito', 'taza', 'tazon'].some(tipo => 
                                         pedido.nombre.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(tipo)
                                     );
                        
                        if (esCafe && pedido.notas && pedido.notas.length > 0) {
                            const tipoCafe = pedido.notas[0].texto;
                            const tipoLimpio = tipoCafe
                                .replace(/^Tipo:?\s*/i, '')
                                .replace(/[^\w\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/g, '')
                                .trim();
                            return `${obtenerEmojiCategoria(pedido.nombre)} ${pedido.nombre}: ${tipoLimpio}`;
                        }
                        
                        return `${obtenerEmojiCategoria(pedido.nombre)} ${pedido.nombre}`;
                    };

                    // Agrupar pedidos por cliente para Take Away Barra
                    let contenidoPedidos = '';
                    if (mesa.nombre === 'Take Away Barra' && tienePedidosPendientes) {
                        const pedidosPorCliente = {};
                        pedidosPendientes.forEach(pedido => {
                            const cliente = pedido.cliente || 'Cliente sin nombre';
                            if (!pedidosPorCliente[cliente]) {
                                pedidosPorCliente[cliente] = {
                                    pedidos: [],
                                    totalItems: 0
                                };
                            }
                            pedidosPorCliente[cliente].pedidos.push(pedido);
                            pedidosPorCliente[cliente].totalItems += (pedido.cantidad || 1);
                        });

                        contenidoPedidos = `
                            <div class="accordion mt-3" id="accordionMesa${mesa.id}" onclick="event.stopPropagation()">
                                ${Object.entries(pedidosPorCliente).map(([cliente, datos], index) => `
                                    <div class="card mb-3 border-primary">
                                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">üë§ ${cliente}</h6>
                                            <span class="badge bg-light text-primary">${datos.totalItems} items</span>
                                        </div>
                                        <div class="card-body p-2">
                                            ${datos.pedidos.map(pedido => `
                                                <div class="card mb-2">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h6 class="mb-0">
                                                                ${formatearNombrePedido(pedido)}
                                                            </h6>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <span class="badge bg-secondary">
                                                                    ${pedido.cantidad}x
                                                                </span>
                                                                ${esAdmin ? `
                                                                    <button class="btn btn-outline-danger btn-sm py-0 px-2" 
                                                                            onclick="event.stopPropagation(); cancelarPedido(event, '${mesa.id}', '${pedido.id}')">
                                                                        ‚ùå
                                                                    </button>
                                                                ` : ''}
                                                        </div>
                                                        </div>
                                                        ${pedido.notas && pedido.notas.length > 0 && !pedido.nombre.toLowerCase().includes('caf√©') && 
                                                          !['pocillo', 'jarrito', 'taza', 'taz√≥n'].some(tipo => 
                                                              pedido.nombre.toLowerCase().includes(tipo.toLowerCase())
                                                          ) ? `
                                                            <div class="alert alert-info py-1 px-2 mb-0 mt-2">
                                                                <small>üìù ${pedido.notas.map(n => n.texto).join(', ')}</small>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            <button class="btn btn-success w-100 mt-2" onclick='pagarCuentaCliente("${mesa.id}", "${cliente}")'>
                                                üí≥ Pagar Cuenta de ${cliente}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${esAdmin ? `
                                <button class='btn btn-warning btn-sm w-100 mt-2' onclick='reiniciarMesa(event, "${mesa.id}")'>
                                    üîÑ Reiniciar Mesa
                                </button>
                            ` : ''}
                        `;
                    } else if (tienePedidosPendientes) {
                        // Visualizaci√≥n para otras mesas con pedidos pendientes
                        contenidoPedidos = `
                            <div class="accordion mt-3" id="accordionMesa${mesa.id}" onclick="event.stopPropagation()">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button p-2 ${acordeonesAbiertos[`collapsePendientes${mesa.id}`] ? '' : 'collapsed'}" 
                                                type="button" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#collapsePendientes${mesa.id}">
                                            <div class="d-flex justify-content-between align-items-center w-100">
                                                <span>üìã Pedidos</span>
                                                <span class="badge bg-warning text-dark ms-2">${totalItemsPendientes} items</span>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapsePendientes${mesa.id}" 
                                         class="accordion-collapse collapse ${acordeonesAbiertos[`collapsePendientes${mesa.id}`] ? 'show' : ''}">
                                        <div class="accordion-body p-2">
                                            ${pedidosPendientes.map(pedido => `
                                                <div class="card mb-2">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h6 class="mb-0">
                                                                ${formatearNombrePedido(pedido)}
                                                            </h6>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <span class="badge bg-secondary">
                                                                    ${pedido.cantidad}x
                                                                </span>
                                                                ${esAdmin ? `
                                                                    <button class="btn btn-outline-danger btn-sm py-0 px-2" 
                                                                            onclick="event.stopPropagation(); cancelarPedido(event, '${mesa.id}', '${pedido.id}')">
                                                                        ‚ùå
                                                                    </button>
                                                                ` : ''}
                                                        </div>
                                                        </div>
                                                        ${pedido.notas && pedido.notas.length > 0 && !pedido.nombre.toLowerCase().includes('caf√©') && 
                                                          !['pocillo', 'jarrito', 'taza', 'taz√≥n'].some(tipo => 
                                                              pedido.nombre.toLowerCase().includes(tipo.toLowerCase())
                                                          ) ? `
                                                            <div class="alert alert-info py-1 px-2 mb-0 mt-2">
                                                                <small>üìù ${pedido.notas.map(n => n.texto).join(', ')}</small>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class='btn btn-success btn-sm w-100' onclick='pagarCuenta("${mesa.id}")'>
                                    üí≥ Pagar Cuenta
                                </button>
                                ${esAdmin ? `
                                    <button class='btn btn-warning btn-sm w-100 mt-2' onclick='reiniciarMesa(event, "${mesa.id}")'>
                                        üîÑ Reiniciar Mesa
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    }

                    return `
                        <div class="col">
                            <div class="card h-100 ${tienePedidosPendientes ? 'border-warning' : 'border-success'} shadow-sm">
                                <div class="card-body" onclick="abrirGestionPedidos('${mesa.id}', '${mesa.nombre}')" style="cursor: pointer;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="card-title mb-0">
                                            ${tienePedidosPendientes ? 'üü†' : 'üü¢'} ${mesa.nombre}
                                        </h5>
                                    </div>
                                    ${contenidoPedidos}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                console.error('Error al cargar el mapa de mesas:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function resetearEstadoPedidos() {
    pedidosPendientes = [];
    clienteActual = null;
    contadorPedidos = 0;
    platoSeleccionado = null;
    esTakeAway = false;
}

function abrirGestionPedidos(mesaId, mesaNombre) {
    // Resetear estado si cambiamos de mesa
    if (mesaActual !== mesaId) {
        resetearEstadoPedidos();
    }
    
    mesaActual = mesaId;
    esTakeAway = mesaNombre === 'Take Away Barra';
    document.getElementById('numeroMesaActual').textContent = mesaNombre;
    
    // Si es Take Away Barra, pedir nombre del cliente
    if (esTakeAway) {
        const nombreClienteModal = new bootstrap.Modal(document.getElementById('nombreClienteModal'));
        nombreClienteModal.show();
        return;
    }
    
    continuarAbrirGestionPedidos();
}

function confirmarNombreCliente() {
    const nombreCliente = document.getElementById('nombreCliente').value.trim();
    if (!nombreCliente) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'error',
            title: 'El nombre del cliente es obligatorio para Take Away'
        });
        return;
    }
    
    clienteActual = nombreCliente;
    bootstrap.Modal.getInstance(document.getElementById('nombreClienteModal')).hide();
    continuarAbrirGestionPedidos();
    
    // Limpiar el campo para futuros usos
    document.getElementById('nombreCliente').value = '';
}

function normalizarTexto(texto) {
    return texto.normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Eliminar acentos
                .toLowerCase()
                .trim();
}

function filtrarPlatos(busqueda) {
    busqueda = normalizarTexto(busqueda);
    const categorias = document.querySelectorAll('.categoria-menu');
    
    categorias.forEach(categoria => {
        let tieneItemsVisibles = false;
        const itemsCategoria = categoria.querySelectorAll('.item-menu');
        
        itemsCategoria.forEach(item => {
            const nombre = normalizarTexto(item.dataset.nombre);
            const descripcion = normalizarTexto(item.dataset.descripcion);
            const coincide = nombre.includes(busqueda) || descripcion.includes(busqueda);
            
            item.style.display = coincide ? '' : 'none';
            if (coincide) tieneItemsVisibles = true;
        });
        
        // Mostrar/ocultar categor√≠a completa
        categoria.style.display = tieneItemsVisibles ? '' : 'none';
    });
}

function continuarAbrirGestionPedidos() {
    fetch('/api/menu')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error al cargar el men√∫:', data.error);
                return;
            }
            
            menuCompleto = data.menu;
            
            // Definir el orden de las categor√≠as
            const ordenCategorias = ['combos', 'cafeteria', 'bebidas', 'salados', 'dulces'];
            
            // Generar HTML para cada categor√≠a en el orden especificado
            let menuHTML = '';
            ordenCategorias.forEach(categoria => {
                const items = data.menu[categoria] || [];
                if (items.length === 0) return;
                
                const emojisCategoria = {
                    'combos': 'üçΩÔ∏è',
                    'cafeteria': '‚òï',
                    'bebidas': 'ü•§',
                    'salados': 'ü•™',
                    'dulces': 'üç∞'
                };
                
                menuHTML += `
                    <div class="card mb-3 categoria-menu" data-categoria="${categoria}">
                        <div class="card-header">
                            <h6 class="mb-0">${emojisCategoria[categoria]} ${categoria.toUpperCase()}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row row-cols-1 row-cols-md-2 g-2">
                `;
                
                items.forEach(item => {
                    if (item.disponible) {
                        menuHTML += `
                            <div class="col item-menu" data-nombre="${item.nombre.toLowerCase()}" data-descripcion="${(item.descripcion || []).join(' ').toLowerCase()}">
                                <div class="card h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">${item.nombre}</h6>
                                        ${item.descripcion && item.descripcion.length > 0 ? 
                                            `<p class="card-text small text-muted mb-1">${item.descripcion.join(', ')}</p>` : ''}
                                        <p class="card-text">
                                            <small class="text-primary">$${item.precio}</small>
                                        </p>
                                        <button class="btn btn-sm btn-outline-primary w-100" onclick="agregarPedido(${item.id})">
                                                Agregar
                                            </button>
                                        </div>
                                    </div>
                            </div>
                        `;
                    }
                });
                
                menuHTML += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            console.log('HTML generado:', menuHTML);
            listaMenu.innerHTML = menuHTML;
            
            // Mostrar el modal
            const pedidosMesaModal = new bootstrap.Modal(document.getElementById('pedidosMesaModal'));
            
            // Agregar evento para limpiar estado al cerrar el modal
            document.getElementById('pedidosMesaModal').addEventListener('hidden.bs.modal', function () {
                resetearEstadoPedidos();
                actualizarPedidosPendientes();
                // Limpiar campo de b√∫squeda al cerrar
                document.getElementById('buscarPlato').value = '';
            });
            
            pedidosMesaModal.show();
        })
        .catch(error => {
            console.error('Error al cargar el men√∫:', error);
        });
}

function agregarPedido(platoId) {
    // Buscar el plato en todas las categor√≠as
    let platoEncontrado = null;
    for (const categoria in menuCompleto) {
        const plato = menuCompleto[categoria].find(p => p.id === parseInt(platoId));
        if (plato) {
            platoEncontrado = plato;
            break;
        }
    }

    if (!platoEncontrado) return;

    // Verificar si es un producto de cafeter√≠a
    const productosCafeteria = ['Pocillo', 'Jarrito', 'Taza', 'Taz√≥n', 'Caf√© para llevar chico', 'Caf√© para llevar grande'];
    
    if (productosCafeteria.includes(platoEncontrado.nombre)) {
        platoSeleccionado = platoEncontrado;
        const tipoCafeModal = new bootstrap.Modal(document.getElementById('tipoCafeModal'));
        tipoCafeModal.show();
    } else {
        agregarPedidoConNota(platoEncontrado);
    }
}

function seleccionarTipoCafe(tipo) {
    if (platoSeleccionado) {
        const emojis = {
            'Caf√© solo (caf√© puro)': '‚òï',
            'Caf√© cortado (caf√© con un poco de leche)': '‚òï',
            'L√°grima (leche con un poco de caf√©)': 'ü•õ',
            'Caf√© con leche (mitad caf√©, mitad leche)': '‚òïü•õ'
        };
        
        const emoji = emojis[tipo] || '‚òï';
        agregarPedidoConNota(platoSeleccionado, `${emoji} ${tipo}`);
        platoSeleccionado = null;
        bootstrap.Modal.getInstance(document.getElementById('tipoCafeModal')).hide();
    }
}

function agregarPedidoConNota(plato, nota = null) {
    // Validar que haya nombre de cliente para Take Away
    if (esTakeAway && !clienteActual) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'error',
            title: 'Es necesario ingresar el nombre del cliente para Take Away'
        });
        return;
    }

    // Verificar si el plato ya est√° en pedidos pendientes
    const pedidoExistente = pedidosPendientes.find(p => {
        // Si es un caf√©, comparar tambi√©n el tipo
        if (nota && p.plato_id === plato.id && p.notas && p.notas.length > 0) {
            return p.notas[0].texto === `Tipo: ${nota}`;
        }
        // Si no es un caf√© o no tiene nota, comparar solo el ID
        return !nota && p.plato_id === plato.id;
    });
    
    if (pedidoExistente) {
        // Mostrar modal para aumentar cantidad
        Swal.fire({
            title: 'Plato ya agregado',
            html: `
                <div class="text-center">
                    <p class="mb-3">${plato.nombre} ${nota ? `(${nota})` : ''} ya est√° en tu pedido.</p>
                    <p class="mb-3">Cantidad actual: ${pedidoExistente.cantidad}</p>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <button class="btn btn-outline-primary" onclick="cambiarCantidad(-1)">-</button>
                        <input type="number" id="nuevaCantidad" class="form-control text-center" 
                               style="width: 80px" value="${pedidoExistente.cantidad}" min="1">
                        <button class="btn btn-outline-primary" onclick="cambiarCantidad(1)">+</button>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Actualizar',
            cancelButtonText: 'Cancelar',
            didOpen: () => {
                // Agregar event listeners para los botones + y -
                window.cambiarCantidad = (delta) => {
                    const input = document.getElementById('nuevaCantidad');
                    const nuevoValor = Math.max(1, parseInt(input.value) + delta);
                    input.value = nuevoValor;
                };

                // Agregar validaci√≥n al input
                const input = document.getElementById('nuevaCantidad');
                input.addEventListener('change', () => {
                    input.value = Math.max(1, parseInt(input.value) || 1);
                });
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const nuevaCantidad = parseInt(document.getElementById('nuevaCantidad').value);
                if (nuevaCantidad > 0) {
                    pedidoExistente.cantidad = nuevaCantidad;
                    actualizarPedidosPendientes();
                    
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    Toast.fire({
                        icon: 'success',
                        title: `‚úÖ Cantidad actualizada: ${nuevaCantidad}x ${plato.nombre} ${nota ? `(${nota})` : ''}`
                    });
                }
            }
        });
        return;
    }

    const pedido = {
        id: `${Date.now()}_${contadorPedidos++}`,
        plato_id: plato.id,
        nombre: plato.nombre,
        precio: plato.precio,
        cantidad: 1,
        estado: 'pendiente',
        cliente: clienteActual || 'Mesa General'
    };

    if (nota) {
        pedido.notas = [{
            texto: `Tipo: ${nota}`,
            hora: new Date().toLocaleTimeString()
        }];
    }
    
    pedidosPendientes.push(pedido);
    actualizarPedidosPendientes();
    
    // Mostrar feedback de √©xito
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
    });

    Toast.fire({
        icon: 'success',
        title: `‚úÖ ${pedido.cantidad}x ${pedido.nombre} agregado`
    });
}

function actualizarPedidosPendientes() {
    const contenedor = document.getElementById('pedidosPendientesContainer');
    if (!contenedor) return;

    if (pedidosPendientes.length === 0) {
        contenedor.innerHTML = '<p class="text-muted text-center">No hay pedidos pendientes</p>';
        return;
    }
    
    // Agrupar pedidos por cliente si es Take Away
    const pedidosPorCliente = {};
    pedidosPendientes.forEach(pedido => {
        const cliente = pedido.cliente || 'Mesa General';
        if (!pedidosPorCliente[cliente]) {
            pedidosPorCliente[cliente] = [];
        }
        pedidosPorCliente[cliente].push(pedido);
    });
    
    const html = Object.entries(pedidosPorCliente).map(([cliente, pedidos]) => `
        <div class="card mb-2">
            ${esTakeAway ? `
                <div class="card-header py-2">
                <h6 class="mb-0">Cliente: ${cliente}</h6>
            </div>
            ` : ''}
            <div class="card-body p-2">
                ${pedidos.map(pedido => `
                    <div class="d-flex justify-content-between align-items-start border-bottom pb-2 mb-2">
                                <div>
                                    <h6 class="mb-1">${pedido.nombre}</h6>
                                    ${pedido.notas && pedido.notas.length > 0 ? 
                                `<small class="text-primary d-block">${pedido.notas[0].texto}</small>` : ''}
                                    <small class="text-muted d-block">
                                $${pedido.precio} c/u | Total: $${(pedido.precio * pedido.cantidad).toFixed(2)}
                                    </small>
                                </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="actualizarCantidad('${pedido.id}', ${Math.max(1, pedido.cantidad - 1)})">-</button>
                                <button class="btn btn-outline-primary" disabled>${pedido.cantidad}</button>
                                <button class="btn btn-outline-primary" onclick="actualizarCantidad('${pedido.id}', ${pedido.cantidad + 1})">+</button>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarPedidoPendiente('${pedido.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');

    contenedor.innerHTML = html;
}

function actualizarCantidad(pedidoId, nuevaCantidad) {
    const pedido = pedidosPendientes.find(p => p.id === pedidoId);
    if (pedido) {
        pedido.cantidad = Math.max(1, nuevaCantidad);
        actualizarPedidosPendientes();
        
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'success',
            title: `‚úÖ Cantidad actualizada: ${pedido.cantidad}x ${pedido.nombre}`
        });
    }
}

function eliminarPedidoPendiente(pedidoId) {
    // Encontrar el pedido antes de eliminarlo para mostrar sus detalles
    const pedido = pedidosPendientes.find(p => p.id === pedidoId);
    
    // Eliminar el pedido
    pedidosPendientes = pedidosPendientes.filter(p => p.id !== pedidoId);
    actualizarPedidosPendientes();

    // Mostrar mensaje de confirmaci√≥n
    if (pedido) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'success',
            title: `‚ùå ${pedido.cantidad}x ${pedido.nombre} eliminado`
        });
    }
}

function cancelarPedido(event, mesaId, pedidoId) {
    event.stopPropagation();
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: true,
        showCancelButton: true,
        timer: 5000,
        timerProgressBar: true
    });

    Toast.fire({
        title: '¬øCancelar pedido?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠',
        cancelButtonText: 'No'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/mozos/pedidos/${pedidoId}/cancelar`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mesa_id: mesaId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarMapaMesas();
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    Toast.fire({
                        icon: 'success',
                        title: 'Pedido cancelado correctamente'
                    });
                } else {
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    Toast.fire({
                        icon: 'error',
                        title: 'Error al cancelar el pedido: ' + data.error
                    });
                }
            })
            .catch(error => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

                Toast.fire({
                    icon: 'error',
                    title: 'Error al cancelar el pedido'
                });
            });
        }
    });
}

function enviarPedidosCocina() {
    if (pedidosPendientes.length === 0) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'warning',
            title: 'No hay pedidos para enviar'
        });
        return;
    }

    // Validar nombre de cliente para Take Away
    if (esTakeAway) {
        const pedidosSinCliente = pedidosPendientes.some(p => !p.cliente || p.cliente === 'Mesa General');
        if (pedidosSinCliente) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });

            Toast.fire({
                icon: 'error',
                title: 'Todos los pedidos de Take Away deben tener un nombre de cliente'
            });
            return;
        }
    }
    
    // Asegurarnos de que los pedidos tengan el cliente asignado y mantener precios unitarios
    const pedidosConCliente = pedidosPendientes.map(pedido => ({
        ...pedido,
        cliente: pedido.cliente || clienteActual || 'Mesa General',
        precio_unitario: pedido.precio,  // Mantener referencia expl√≠cita al precio unitario
        precio_total: pedido.precio * pedido.cantidad  // Calcular precio total
    }));
    
    fetch(`/api/mesas/${mesaActual}/enviar-cocina`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            pedidos: pedidosConCliente,
            mozo: esAdmin ? 'Admin' : 'Mozo'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resetearEstadoPedidos();
            // Cerrar el modal
            bootstrap.Modal.getInstance(document.getElementById('pedidosMesaModal')).hide();
            // Actualizar el mapa de mesas
            actualizarMapaMesas();
            
            // Mostrar notificaci√≥n toast
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });

            Toast.fire({
                icon: 'success',
                title: '‚úÖ Pedidos enviados correctamente'
            });
        } else {
            Swal.fire({
                title: 'Error',
                text: data.error || 'Error al enviar pedidos',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error',
            text: 'Error al enviar pedidos',
            icon: 'error',
            confirmButtonText: 'Aceptar'
        });
    });
}

function reiniciarMesa(event, mesaId) {
    event.stopPropagation();
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: true,
        showCancelButton: true,
        timer: 5000,
        timerProgressBar: true
    });

    Toast.fire({
        title: '¬øReiniciar mesa?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠',
        cancelButtonText: 'No'
    }).then((result) => {
        if (result.isConfirmed) {
        fetch(`/api/mozos/mesas/${mesaId}/reiniciar`, {
            method: 'PUT'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                actualizarMapaMesas();
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    Toast.fire({
                        icon: 'success',
                        title: 'Mesa reiniciada correctamente'
                    });
            } else {
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    Toast.fire({
                        icon: 'error',
                        title: 'Error al reiniciar la mesa: ' + data.error
                    });
            }
        })
        .catch(error => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

                Toast.fire({
                    icon: 'error',
                    title: 'Error al reiniciar la mesa'
                });
            });
        }
    });
}

function pagarCuenta(mesaId) {
    event.stopPropagation();
    
    fetch(`/api/mozos/mesas/${mesaId}/pedidos`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al obtener los pedidos: ' + data.error,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            const pedidosPendientes = data.pedidos.filter(p => 
                p.estado_cocina === 'üü° Pendiente' && !p.estado_cocina.includes('üî¥')
            );

            if (pedidosPendientes.length === 0) {
                Swal.fire({
                    title: 'Atenci√≥n',
                    text: 'No hay pedidos pendientes para pagar',
                    icon: 'warning',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Agrupar pedidos por cliente
            const pedidosPorCliente = {};
            pedidosPendientes.forEach(pedido => {
                const cliente = pedido.cliente || 'Mesa General';
                if (!pedidosPorCliente[cliente]) {
                    pedidosPorCliente[cliente] = [];
                }
                
                // Desglosar pedidos con cantidad > 1 en √≠tems individuales
                for (let i = 0; i < pedido.cantidad; i++) {
                    const itemIndividual = {
                        ...pedido,
                        cantidad_original: pedido.cantidad,
                        cantidad: 1,
                        precio_individual: pedido.precio,  // Mantener precio unitario original
                        item_index: i + 1
                    };
                    pedidosPorCliente[cliente].push(itemIndividual);
                }
            });

            // Crear modal de pago con agrupaci√≥n por cliente
            const modalPago = `
                <div class="modal fade" id="modalPago" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Pagar Cuenta</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${Object.entries(pedidosPorCliente).map(([cliente, pedidos]) => `
                                    <div class="card mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <div class="form-check">
                                                <input class="form-check-input cliente-check" type="checkbox" 
                                                       value="${cliente}" id="cliente_${cliente}"
                                                       onchange="toggleClientePedidos('${cliente}')" checked>
                                                <label class="form-check-label text-white" for="cliente_${cliente}">
                                                    ${cliente}
                                                </label>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="list-group">
                                                ${pedidos.map(pedido => `
                                                    <div class="list-group-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input pedido-check" type="checkbox" 
                                                                   value="${pedido.id}" 
                                                                   id="pedido_${pedido.id}_${pedido.item_index}" 
                                                                   data-cliente="${cliente}"
                                                                   data-precio="${pedido.precio_individual}"
                                                                   data-item-index="${pedido.item_index}"
                                                                   data-cantidad-original="${pedido.cantidad_original}"
                                                                   checked
                                                                   onchange="actualizarTotal()">
                                                            <label class="form-check-label" for="pedido_${pedido.id}_${pedido.item_index}">
                                                                ${pedido.nombre} - $${pedido.precio_individual}
                                                                ${pedido.cantidad_original > 1 ? 
                                                                    `<small class="text-muted">(√çtem ${pedido.item_index} de ${pedido.cantidad_original})</small>` : 
                                                                    ''}
                                                                ${pedido.notas ? `<br><small class="text-primary">${pedido.notas.map(n => n.texto).join(', ')}</small>` : ''}
                                                            </label>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                                <div class="mb-3">
                                    <h6>M√©todo de Pago:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo" checked>
                                        <label class="form-check-label" for="efectivo">Efectivo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta">
                                        <label class="form-check-label" for="tarjeta">Tarjeta</label>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <h6 class="mb-0">Total a pagar: $<span id="totalPagar">0</span></h6>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="procesarPago('${mesaId}')">Pagar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalPago);
            const modal = new bootstrap.Modal(document.getElementById('modalPago'));
            modal.show();
            actualizarTotal();

            document.getElementById('modalPago').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al cargar los pedidos',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        });
}

function actualizarTotal() {
    const checkboxes = document.querySelectorAll('.pedido-check:checked');
    let total = 0;
    
    checkboxes.forEach(checkbox => {
        total += parseFloat(checkbox.dataset.precio);
    });
    
    document.getElementById('totalPagar').textContent = total.toFixed(2);
}

function procesarPago(mesaId) {
    // Obtener pedidos seleccionados y agruparlos
    const pedidosSeleccionados = {};
    
    Array.from(document.querySelectorAll('.pedido-check:checked')).forEach(checkbox => {
        const id = checkbox.value;
        const itemIndex = parseInt(checkbox.dataset.itemIndex);
        const cantidadOriginal = parseInt(checkbox.dataset.cantidadOriginal);
        
        if (!pedidosSeleccionados[id]) {
            pedidosSeleccionados[id] = {
                items: new Set(),
                cantidadOriginal: cantidadOriginal
            };
        }
        pedidosSeleccionados[id].items.add(itemIndex);
    });
    
    // Convertir a formato para enviar al servidor
    const pedidosParaPagar = Object.entries(pedidosSeleccionados).map(([id, data]) => ({
        id: id,
        cantidad: data.items.size
    }));

    if (pedidosParaPagar.length === 0) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'warning',
            title: 'Debe seleccionar al menos un √≠tem para pagar'
        });
        return;
    }

    // Obtener m√©todo de pago
    const metodoPago = document.querySelector('input[name="metodoPago"]:checked').value;

    const datosPago = {
        mozo: esAdmin ? 'Admin' : 'Mozo',
        pedidos_ids: pedidosParaPagar,
        metodo_pago: metodoPago
    };

    // Realizar el pago
    fetch(`/api/mozos/mesas/${mesaId}/pagar`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datosPago)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal de pago inmediatamente
            bootstrap.Modal.getInstance(document.getElementById('modalPago')).hide();
            
            // Mostrar mensaje de √©xito permanente
            Swal.fire({
                title: '¬°Pago exitoso!',
                text: `Total pagado: $${data.total}`,
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
            
            // Actualizar mapa de mesas
            actualizarMapaMesas();
        } else {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });

            Toast.fire({
                icon: 'error',
                title: 'Error al procesar el pago: ' + data.error
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        Toast.fire({
            icon: 'error',
            title: 'Error al procesar el pago'
        });
    });
}

function toggleClientePedidos(cliente) {
    const clienteCheck = document.getElementById(`cliente_${cliente}`);
    const pedidosCliente = document.querySelectorAll(`.pedido-check[data-cliente="${cliente}"]`);
    
    pedidosCliente.forEach(pedido => {
        pedido.checked = clienteCheck.checked;
    });
    
    actualizarTotal();
}

function pagarCuentaCliente(mesaId, cliente) {
    event.stopPropagation();
    
    fetch(`/api/mozos/mesas/${mesaId}/pedidos`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al obtener los pedidos: ' + data.error,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Filtrar solo los pedidos del cliente espec√≠fico
            const pedidosCliente = data.pedidos.filter(p => 
                p.estado_cocina === 'üü° Pendiente' && 
                !p.estado_cocina.includes('üî¥') &&
                p.cliente === cliente
            );

            if (pedidosCliente.length === 0) {
                Swal.fire({
                    title: 'Atenci√≥n',
                    text: 'No hay pedidos pendientes para este cliente',
                    icon: 'warning',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Desglosar pedidos con cantidad > 1 en √≠tems individuales
            const pedidosDesglosados = [];
            pedidosCliente.forEach(pedido => {
                for (let i = 0; i < pedido.cantidad; i++) {
                    pedidosDesglosados.push({
                        ...pedido,
                        cantidad_original: pedido.cantidad,
                        cantidad: 1,
                        precio_individual: pedido.precio,  // Mantener precio unitario original
                        item_index: i + 1
                    });
                }
            });

            // Crear modal de pago espec√≠fico para el cliente
            const modalPago = `
                <div class="modal fade" id="modalPago" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Pagar Cuenta - ${cliente}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">Pedidos de ${cliente}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group">
                                            ${pedidosDesglosados.map(pedido => `
                                                <div class="list-group-item">
                                                    <div class="form-check">
                                                        <input class="form-check-input pedido-check" type="checkbox" 
                                                               value="${pedido.id}" 
                                                               id="pedido_${pedido.id}_${pedido.item_index}"
                                                               data-cliente="${cliente}"
                                                               data-precio="${pedido.precio_individual}"
                                                               data-item-index="${pedido.item_index}"
                                                               data-cantidad-original="${pedido.cantidad_original}"
                                                               checked
                                                               onchange="actualizarTotal()">
                                                        <label class="form-check-label" for="pedido_${pedido.id}_${pedido.item_index}">
                                                            ${pedido.nombre} - $${pedido.precio_individual}
                                                            ${pedido.cantidad_original > 1 ? 
                                                                `<small class="text-muted">(√çtem ${pedido.item_index} de ${pedido.cantidad_original})</small>` : 
                                                                ''}
                                                            ${pedido.notas ? `<br><small class="text-primary">${pedido.notas.map(n => n.texto).join(', ')}</small>` : ''}
                                                        </label>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 mt-3">
                                    <h6>M√©todo de Pago:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo" checked>
                                        <label class="form-check-label" for="efectivo">Efectivo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta">
                                        <label class="form-check-label" for="tarjeta">Tarjeta</label>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <h6 class="mb-0">Total a pagar: $<span id="totalPagar">0</span></h6>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="procesarPago('${mesaId}')">Pagar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalPago);
            const modal = new bootstrap.Modal(document.getElementById('modalPago'));
            modal.show();
            actualizarTotal();

            document.getElementById('modalPago').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al cargar los pedidos',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        });
}

// Agregar el modal de confirmaci√≥n al cerrar
document.addEventListener('DOMContentLoaded', function() {
    const pedidosMesaModal = document.getElementById('pedidosMesaModal');
    
    pedidosMesaModal.addEventListener('hide.bs.modal', function (event) {
        if (pedidosPendientes.length > 0) {
            event.preventDefault();
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: true,
                showCancelButton: true,
                timer: 5000,
                timerProgressBar: true
            });

            Toast.fire({
                title: '¬øCerrar sin guardar?',
                text: 'Hay pedidos sin enviar',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetearEstadoPedidos();
                    bootstrap.Modal.getInstance(pedidosMesaModal).hide();
                }
            });
        }
    });
});

function mostrarResumenDiario() {
    // Obtener la fecha actual
    const fecha = new Date();
    const fechaFormateada = fecha.toLocaleDateString('es-AR');
    const horaFormateada = fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', second: undefined, hour12: false });
    
    // Actualizar fecha y hora en el modal
    document.getElementById('resumenFecha').textContent = fechaFormateada;
    document.getElementById('resumenHora').textContent = horaFormateada;
    
    // Obtener el historial del d√≠a
    fetch('/api/historial/diario')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const historial = data.historial;
                let totalDia = 0;
                let totalEfectivo = 0;
                let totalTarjeta = 0;
                let cantidadPedidos = 0;
                
                // Limpiar tabla
                const tabla = document.getElementById('resumenTabla');
                tabla.innerHTML = '';
                
                // Procesar cada ticket
                historial.forEach(ticket => {
                    // Procesar pedidos del ticket
                    Object.values(ticket.pedidos_por_cliente).forEach(cliente => {
                        cliente.pedidos.forEach(pedido => {
                            // Agregar fila a la tabla
                            const fila = document.createElement('tr');
                            fila.innerHTML = `
                                <td>${ticket.hora.substring(0, 5)}</td>
                                <td>${pedido.nombre}</td>
                                <td class="text-center">${pedido.cantidad}</td>
                                <td class="text-end">$${pedido.precio_unitario}</td>
                                <td class="text-end">$${pedido.precio_total}</td>
                                <td>${capitalizarMetodoPago(ticket.metodo_pago)}</td>
                            `;
                            tabla.appendChild(fila);
                            
                            // Actualizar totales
                            totalDia += pedido.precio_total;
                            cantidadPedidos += pedido.cantidad;
                            
                            // Actualizar totales por m√©todo de pago
                            switch(ticket.metodo_pago.toLowerCase()) {
                                case 'efectivo':
                                    totalEfectivo += pedido.precio_total;
                                    break;
                                case 'tarjeta':
                                    totalTarjeta += pedido.precio_total;
                                    break;
                            }
                        });
                    });
                });
                
                // Actualizar totales en el modal
                document.getElementById('resumenTotal').textContent = totalDia.toFixed(2);
                document.getElementById('resumenPedidos').textContent = cantidadPedidos;
                document.getElementById('totalEfectivo').textContent = `${totalEfectivo.toFixed(2)} (${((totalEfectivo/totalDia)*100).toFixed(1)}%)`;
                document.getElementById('totalTarjeta').textContent = `${totalTarjeta.toFixed(2)} (${((totalTarjeta/totalDia)*100).toFixed(1)}%)`;
            } else {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al cargar el historial: ' + data.error,
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al cargar el historial',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        });
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('resumenDiarioModal'));
    modal.show();
}

function capitalizarMetodoPago(metodo) {
    return metodo.charAt(0).toUpperCase() + metodo.slice(1).toLowerCase();
}

function actualizarFechaHora() {
    const ahora = new Date();
    const opciones = { 
        hour: '2-digit', 
        minute: '2-digit', 
        hour12: false 
    };
    
    // Formatear fecha como DD/MM/YYYY
    const dia = ahora.getDate().toString().padStart(2, '0');
    const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
    const a√±o = ahora.getFullYear();
    const fechaFormateada = `${dia}/${mes}/${a√±o}`;
    
    // Formatear hora en formato 24 horas
    const horaFormateada = ahora.toLocaleTimeString('es-AR', opciones);
    
    document.getElementById('fechaActual').textContent = `üìÖ Fecha: ${fechaFormateada}`;
    document.getElementById('horaActual').textContent = `üïí Hora: ${horaFormateada}`;
}
</script>
{% endblock %} 